<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Secure Chat</title>
  <style>
    body { font-family: sans-serif; background: #121212; color: #fff; display: flex; flex-direction: column; align-items: center; padding: 20px; }
    textarea, input { width: 100%; max-width: 600px; margin: 5px 0; padding: 10px; border-radius: 5px; border: none; }
    button { padding: 10px 20px; border: none; border-radius: 5px; background: #00c853; color: white; cursor: pointer; margin: 5px; }
    .chat { width: 100%; max-width: 600px; height: 300px; overflow-y: auto; background: #1e1e1e; padding: 10px; margin: 10px 0; border-radius: 5px; }
  </style>
</head>
<body>
  <h2>🔐 Secure Chat (Peer-to-Peer)</h2>
  <input type="text" id="room" placeholder="Enter Room Code (Shared Secret)" />
  <div>
    <button onclick="createOffer()">📤 Create Offer</button>
    <button onclick="createAnswer()">📥 Create Answer</button>
  </div>
  <textarea id="signal" rows="4" placeholder="Paste Offer/Answer Here..."></textarea>
  <button onclick="setRemoteDescription()">🔗 Connect</button>
  <div class="chat" id="chatBox"></div>
  <input type="text" id="msg" placeholder="Type your message..." onkeypress="if(event.key === 'Enter') sendMsg()" />
  <button onclick="sendMsg()">Send</button>

  <script>
    let peer, channel;
    const roomInput = document.getElementById('room');
    const signal = document.getElementById('signal');
    const chatBox = document.getElementById('chatBox');
    const msgInput = document.getElementById('msg');

    function log(msg) {
      chatBox.innerHTML += `<div>> ${msg}</div>`;
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function createPeer() {
      peer = new RTCPeerConnection({
        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
      });

      peer.onicecandidate = e => {
        if (!e.candidate) {
          signal.value = JSON.stringify(peer.localDescription);
        }
      };

      peer.ondatachannel = e => {
        channel = e.channel;
        channel.onmessage = e => log(`👤: ${e.data}`);
        channel.onopen = () => log('🟢 Connected!');
      };
    }

    function createOffer() {
      createPeer();
      channel = peer.createDataChannel(roomInput.value);
      channel.onmessage = e => log(`👤: ${e.data}`);
      channel.onopen = () => log('🟢 Connected!');
      peer.createOffer().then(d => peer.setLocalDescription(d));
    }

    function createAnswer() {
      createPeer();
      const desc = JSON.parse(signal.value);
      peer.setRemoteDescription(desc).then(() => {
        peer.createAnswer().then(d => peer.setLocalDescription(d));
      });
    }

    function setRemoteDescription() {
      const desc = JSON.parse(signal.value);
      peer.setRemoteDescription(desc);
    }

    function sendMsg() {
      if (channel && channel.readyState === 'open') {
        channel.send(msgInput.value);
        log(`🧑‍💻: ${msgInput.value}`);
        msgInput.value = '';
      }
    }
  </script>
</body>
</html>
